{% extends 'base.html' %}
{% block grid %}
    <div class="one column grid" style="margin:5px 0 5px 0;">
        <div class="column">
            <div class="ui segment"  id="chart" style="margin:0 5px 0 40px;width: 1250px;height: 690px" ></div>
        </div>
    </div>
{% endblock %}

{% block chartjs %}
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-gl/echarts-gl.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-stat/ecStat.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/dataTool.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/china.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/world.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=qxRiPO1xrQcelt4nYzSbSX2ysdwiMteh"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/simplex.js"></script>

<script type="text/javascript">
    mapboxgl.accessToken ='pk.eyJ1IjoiY2l0eXdhbmRlciIsImEiOiJjamE4ODM2YjQwNDB5MzNwY2hvanV2eDhiIn0.QCJ3-UnEddwCuxg8uvhLcQ';
    var myChart = echarts.init(document.getElementById('chart'));

    var DefaultTime=new Date(2014,5,1,0,0,0);
    
    option=null;
    
    var getChart = function(RequestTime){
        $.ajax({
            type:'get',
            url:'air/',
            dataType: 'json',
            async: true,
            data:{
                time:RequestTime
            },
            success : function (data){
                option=getOption(data,RequestTime);
                if (option && typeof option === "object") {
                    myChart.setOption(option, true);
                }
            }
        })
    }
    
    var convertData = function (data,pollution_name) {
        var res = [];
        console.log(pollution_name);
        console.log(data[0][pollution_name]);
        for (var i in data){
            var value=data[i][pollution_name];
            console.log(value);
            if(value){
                console.log("yes");
                res.push({
                    name:data[i]['name_chinese'],
                    value: [data[i]['longitude'],data[i]['latitude'],value]
                    });
            }
        }
        console.log(res);
        return res;
    };

    var getOption=function(data,time){
        var res = {
            title: {
                text: '京津地区部分城市城区空气质量图',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    var res = params.name+'<br/>';
                    var myseries = option.series;
                    for (var i = 0; i < myseries.length; i++) {
                        for(var j=0;j<myseries[i].data.length;j++){
                            if(myseries[i].data[j].name==params.name){
                                res+=myseries[i].name +' : '+myseries[i].data[j].value[2]+'</br>';
                            }
                        }
                    }
                    return res;
                }
            },
            bmap: {
                center: [116.173553,40.090679],
                zoom: 9,
                roam: true,
                mapStyle: {
                    styleJson: [{
                        'featureType': 'water',
                        'elementType': 'all',
                        'stylers': {
                            'color': '#d1d1d1'
                        }
                    }, {
                        'featureType': 'land',
                        'elementType': 'all',
                        'stylers': {
                            'color': '#f3f3f3'
                        }
                    }, {
                        'featureType': 'railway',
                        'elementType': 'all',
                        'stylers': {
                            'visibility': 'off'
                        }
                    }, {
                        'featureType': 'highway',
                        'elementType': 'all',
                        'stylers': {
                            'color': '#fdfdfd'
                        }
                    }, {
                        'featureType': 'highway',
                        'elementType': 'labels',
                        'stylers': {
                            'visibility': 'off'
                        }
                    }, {
                        'featureType': 'arterial',
                        'elementType': 'geometry',
                        'stylers': {
                            'color': '#fefefe'
                        }
                    }, {
                        'featureType': 'arterial',
                        'elementType': 'geometry.fill',
                        'stylers': {
                            'color': '#fefefe'
                        }
                    }, {
                        'featureType': 'poi',
                        'elementType': 'all',
                        'stylers': {
                            'visibility': 'off'
                        }
                    }, {
                        'featureType': 'green',
                        'elementType': 'all',
                        'stylers': {
                            'visibility': 'off'
                        }
                    }, {
                        'featureType': 'subway',
                        'elementType': 'all',
                        'stylers': {
                            'visibility': 'off'
                        }
                    }, {
                        'featureType': 'manmade',
                        'elementType': 'all',
                        'stylers': {
                            'color': '#d1d1d1'
                        }
                    }, {
                        'featureType': 'local',
                        'elementType': 'all',
                        'stylers': {
                            'color': '#d1d1d1'
                        }
                    }, {
                        'featureType': 'arterial',
                        'elementType': 'labels',
                        'stylers': {
                            'visibility': 'off'
                        }
                    }, {
                        'featureType': 'boundary',
                        'elementType': 'all',
                        'stylers': {
                            'color': '#fefefe'
                        }
                    }, {
                        'featureType': 'building',
                        'elementType': 'all',
                        'stylers': {
                            'color': '#d1d1d1'
                        }
                    }, {
                        'featureType': 'label',
                        'elementType': 'labels.text.fill',
                        'stylers': {
                            'color': '#999999'
                        }
                    }]
                }
            },
            series : [
                {
                    name: 'PM2.5',
                    type: 'scatter',
                    coordinateSystem: 'bmap',
                    data: convertData(data,'PM25_Concentration'),
                    symbolSize: function (val) {
                        return 10;
                    },
                    label: {
                        normal: {         
                            formatter: '{b}',
                            position: 'right',
                            show: true
                        },
                        emphasis: {
                            show: true
                        }
                    },
                    itemStyle: {  
                        normal: {
                            color: 'purple'
                        }
                    }
                },
                {
                    name: 'PM10',
                    type: 'scatter',
                    coordinateSystem: 'bmap',
                    data: convertData(data,'PM10_Concentration'),
                    symbolSize: function (val) {
                        return 0;
                    },
                    itemStyle: {
                        normal: {
                            color: 'purple'
                        }
                    }
                },
                {
                    name: 'NO2',
                    type: 'scatter',
                    coordinateSystem: 'bmap',
                    data: convertData(data,'NO2_Concentration'),
                    symbolSize: function (val) {
                        return 0;
                    },
                    itemStyle: {
                        normal: {
                            color: 'purple'
                        }
                    }
                },
                {
                    name: 'CO',
                    type: 'scatter',
                    coordinateSystem: 'bmap',
                    data: convertData(data,'CO_Concentration'),
                    symbolSize: function (val) {
                        return 0;
                    },
                    itemStyle: {
                        normal: {
                            color: 'purple'
                        }
                    }
                },
                {
                    name: 'O3',
                    type: 'scatter',
                    coordinateSystem: 'bmap',
                    data: convertData(data,'O3_Concentration'),
                    symbolSize: function (val) {
                        return 0;
                    },
                    itemStyle: {
                        normal: {
                            color: 'purple'
                        }
                    }
                },
                {
                    name: 'SO2',
                    type: 'scatter',
                    coordinateSystem: 'bmap',
                    data: convertData(data,'SO2_Concentration'),
                    symbolSize: function (val) {
                        return 0;
                    },
                    itemStyle: {
                        normal: {
                            color: 'purple'
                        }
                    }
                }
            ]
        }
        return res;
    }

    getChart(DefaultTime);

</script>


{% endblock %}